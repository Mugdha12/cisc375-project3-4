<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8"/>
	<meta name="viewport" content="width=device-width, initial-scale=1"/>
	<title>St. Paul Crime API </title>
 
	<!-- this is the css of leaf let -->
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
   integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
   crossorigin=""/> 
   
   <!-- this is the js for the left let -->
   <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"
   integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew=="
   crossorigin=""></script>
   <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
	<script type="application/javascript" src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
	<script type="application/javascript" src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/vue@2.6.0"></script>

	<link rel="stylesheet" href="css/index.css" ><link>
	<link rel="stylesheet" href="css/normalize.css" ><link>
</head>
<body>
   

	<div id=wrapper>
		<div id="header">
			<h1> St.Paul Crime </h1>
			 <p><a href="index.html">Project </a> | <a href="about.html">About Us</a></p>
		</div>

		<!-- the search bars  -->
		<div id= "searchBox">
				
						<button @click='toogleLatLog = !toogleLatLog'>Lat/Log</button><br>
						<div v-show="!toogleLatLog"> 
						<p> Please input  Lan. and Long. below  </p>
						<input type="number" v-model="lat">
						<input type="number"  v-model="lng">
						<button onclick="coorIntoAddress(); updateMap()"> Enter </button>
					</div>

						<button @click='toogleAdd=!toogleAdd'>Address</button>
						<div v-show = "!toogleAdd"> 
						<p> Please enter your address<p>
						<input type="text"  v-model="address">
						<button onclick="addressIntoCoor()"> Enter </button>
					</div>
		</div>


		<!-- the map  -->
		<div id="mapid"> 
		</div>

		<!-- Vue app  -->
		<div id="app"> 
				
				<button @click='toggleFilter = !toggleFilter; filterCounter =+ 1' id="first"> Filter  </button>				
				<div v-show='!toggleFilter'> 
				
					<ul >
						<!-- time -->
						
						<button @click='toggleTime = !toggleTime'> Time </button>
						<button @click='toggleDate = !toggleDate'> Date </button>
						<button @click='toggleIncident= !toggleIncident'> Incident </button>
						<button @click='toggleNeighbor = !toggleNeighbor'> Neighborhoods</button>
						
						<li  v-show='!toggleTime' >
						<label for="start">Start Time:</label>
						<input type = "time"  min="00:00:00" max = "23:59:59" v-model= "startTime"> <br>
						<label for="end"> End Time:</label>
						<input type = "time"  min="00:00:00" max = "23:59:59" v-model="endTime"> <br>
						</li>
						<!-- calendar -->
						
						<li  v-show='!toggleDate' >
						<label for="start">Start Date:</label>
						<input type="date"   min="2014-08-14" max="2019-10-31" v-model= "form.startDate" @change="dateChange"> <br>
						<label for="end">End Date:</label>
						<input type="date"   min="2014-08-14" max="2019-10-31" v-model="form.endDate" @change="dateChange"><br>
						</li>
						<!-- checklist for incident -->
						
						<li v-for="(incident_type,key) in codes" v-show='!toggleIncident'>
						{{ incident_type}}
						<input type="checkbox"   v-model="checked[key.substring(1)]" />
						</li>

						<!-- checklist for neighborhoods -->	
						
						<li v-for="(neighborhood_name,key) in neighborhoods" v-show='!toggleNeighbor' >
						{{ neighborhood_name}}
						<input type="checkbox"  v-model="checked[key.substring(1)]" />
						</li>
					</ul>
				</div>

		
		<!-- the table of data  -->
		<table id='firstTable'>
				<thead>
					<tr>
						<th> Date</th>
						<th> Time</th>
						<th> Incident</th>
						<th> Code</th>
						<th> Incident</th>
						<th> Police Grid</th>
						<th> Neighborhood Number</th>
						<th> Block</th>
					</tr>
				</thead>
				<tbody >
					<!---v-if="app.checked[row.neighborhood_number] || app.checked[row.incident]"-->
					<tr v-for="(row,key) in incidents" v-if="(checked[row.neighborhood_number] || checked[row.code]) && (row.time >= startTime && row.time <= endTime)">  
					<!---<td>{{row}}</td>--->
						<td>{{row.date}}</td>
						<td>{{row.time}}</td>
						<td> {{key}}</td>
						<td>{{row.code}}</td>
						<td>{{row.incident}}</td>
						<td>{{row.police_grid}}</td>
						<td>{{row.neighborhood_number}}</td>
						<td>{{row.block}}</td>
					</tr>
				</tbody>	
			</table>
		</div>
	</div>

		<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.5.1/leaflet.js"></script>
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.5.1/leaflet.css">


<script type="application/javascript">
			var searchBox = new Vue({
				el:"#searchBox",
				data:{
					lat:44.965272,
					lng: -93.104732,
					address:"",
					toogleLatLog:true,
					toogleAdd:true
				}
			});
			var newIcon = L.icon({iconUrl: 'location-pin.svg', iconSize: [40,40]});
			
			var locations = [
					["Conway/Battlecreek/Highwood",44.927682,-93.026969],
					["Greater East Side",44.979412,-93.027130],
					["West Side",44.928185, -93.092870],
					["Dayton's Bluff",44.951677,-93.060792],
					["Payne/Phalen",44.982648,-93.066961],
					["North End",44.982424,-93.117494],
					["Thomas/Dale(Frogtown)",44.959133, -93.131401],
					["Summit/University",44.950551,-93.136059],
					["West Seventh",44.929653, -93.131413],
					["Como", 44.980167,-93.141662],
					["Hamline/Midway",44.963469,-93.158237],
					["St. Anthony", 44.971234, -93.198223],
					["Union Park", 44.948230, -93.189333],
					["Macalester-Groveland", 44.930514, -93.182059],
					["Highland", 44.917279, -93.159709],
					["Summit Hill", 44.936637, -93.139830],
					["Capitol River",44.957940, -93.103392]	
				];
	 	// Script for adding marker on map click
				var mymap = L.map('mapid').setView([searchBox.lat, searchBox.lng],12);
				L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}', {
				attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
				maxZoom: 17,
				minZoom:12,
				center: [searchBox.lat, searchBox.lng],
				id: 'mapbox/streets-v11',
				draggable: false,
				accessToken: 'pk.eyJ1IjoibWl0emlidXN0YW1hbnRlIiwiYSI6ImNrM3VkOGoyYjBja2MzdG1yMzd6anEzYTIifQ.H2RDitN6lPMzEf2n_Ag9Ng'
				}).addTo(mymap);
				var numIncidents; 


				//can't move it outside st.paul
				var nWest = L.latLng(44.967595, -93.192643);
				var sEast = L.latLng(44.940768, -93.044095);
				var myBounds = L.latLngBounds(nWest, sEast);
				mymap.setMaxBounds(myBounds);	


				//changing the address
				function addressIntoCoor(){
					var nAddr = searchBox.address.replace(/\s/g, "%20");
					var url = "https://nominatim.openstreetmap.org/search?format=json&limit=1&state=Minnesota&city=Saint%20Paul&street=" + nAddr;
					//console.log(url);
					$.getJSON(url, function(data){
						searchBox.lat = data[0]["lat"];
						//console.log(data[0]["lon"]);
						searchBox.lng = data[0]["lon"];
					});
					updateMap();
				}
				function coorIntoAddress(){
				var url = "https://nominatim.openstreetmap.org/reverse?format=json&lat="+searchBox.lat+"&lon="+searchBox.lng;
				$.getJSON(url, function(data){
						searchBox.address = "";
						if(data["address"]["house_number"] != null)
						{
							searchBox.address = data["address"]["house_number"];
						}
						searchBox.address = searchBox.address +  " " + data["address"]["road"];
					});
					console.log(searchBox.address);
					updateMap();
				}
				function populateIncidents(data)
				{
					for(let j in data)
					{
						numIncidents[Number(data[j]["neighborhood_number"])] = numIncidents[Number(data[j]["neighborhood_number"])] + 1;
					}
					for (let i = 0; i < locations.length; i++) {
						marker = new L.marker([locations[i][1],locations[i][2]])
						.bindPopup(locations[i][0] + ": <br /> Crime Number:" + numIncidents[i+1])
						.addTo(mymap);
					}

				}
				
				// rough outline of st.paul 
				var polygon = L.polygon([
					[44.890754, -93.003751],
					[44.921335, -93.048377],
					[44.919512, -93.130088],
					[44.888386, -93.177123],
					[44.987541, -93.206992],
					[44.990698, -93.006492],
				]).addTo(mymap);

				function getCenter(){
					var currentCenter = mymap.getCenter();
					var bounds = mymap.getBounds();
					searchBox.lat = currentCenter.lat;
					searchBox.lng = currentCenter.lng;					
				}

				let popup = L.popup();
				mymap.on('click',function(e){
					popup.setLatLng(e.latlng).setContent("You have clicked on the map at" + e.latlng.toString()).openOn(mymap);
				});
				// get the coor after it stop zooming 
				mymap.on('zoomend', function() {
						getCenter();
				});

				//get the coor after it's stop dragged 
				mymap.on('dragged', function() {
					getCenter();
				});
				
				//searck lat.lng works - puts markers
				function updateMap (){
					mymap.panTo(new L.latLng(searchBox.lat,searchBox.lng));
					marker = L.marker([searchBox.lat, searchBox.lng],{icon: newIcon}).addTo(mymap)
					.bindPopup("Lat = " + searchBox.lat + "<br /> Lng = "+ searchBox.lng);
				}

			
				
		</script>	
		
		<script type="application/javascript">
			
			var app = new Vue({
				el:"#app",
				data:{
					form:{
						startDate:"2019-10-01",
						endDate:"2019-10-31"
					},
					codes:{},
					startTime:"00:00:00",
					endTime:"23:59:59",
					neighborhoods:{},
					checked:{},
					incidents:{},
					toggleFilter:true,
					filterCounter:0,
					toggleTime:true,
					toggleDate:true,
					toggleIncident:true,
					toggleNeighbor:true,
				}
			});
			
			
			Promise.all([$.getJSON("http://localhost:8000/codes"), $.getJSON("http://localhost:8000/neighborhoods"), $.getJSON( "http://localhost:8000/incidents?start_date=" + app.form.startDate + "&end_date=" + app.form.endDate)])
			.then(

			);
			//gets the date codes
			$.getJSON("http://localhost:8000/codes", function(data){
				app.codes = data;	
				let tmp = {};
				for(let j in data)
				{	
					tmp[parseInt(j.substring(1))] = true;

				}
				app.checked = tmp;
			
			});
		
			//get the data from neighborhoods
			$.getJSON("http://localhost:8000/neighborhoods", function(data){
				app.neighborhoods = data;
				let tmp = {};

				for(let j in data)
				{	
					tmp[parseInt(j.substring(1))] = true;
					
				}
				app.checked = tmp;
			});

			$.getJSON( "http://localhost:8000/incidents?start_date=" + app.form.startDate + "&end_date=" + app.form.endDate, function(data){
				app.incidents = data;
				numIncidents={1:0, 2:0, 3:0, 4:0, 5:0, 6:0, 7:0, 8:0, 9:0, 10:0, 11:0, 12:0, 13:0, 14:0, 15:0, 16:0, 17:0};
				populateIncidents(data);
				
			});

			function dateChange()
			{
				$.getJSON( "http://localhost:8000/incidents?start_date=" + app.form.startDate + "&end_date=" + app.form.endDate, function(data){
					app.incidents = data;
					numIncidents={1:0, 2:0, 3:0, 4:0, 5:0, 6:0, 7:0, 8:0, 9:0, 10:0, 11:0, 12:0, 13:0, 14:0, 15:0, 16:0, 17:0};
					populateIncidents(data);
				});
			}
		</script>  
</body>
</html>
